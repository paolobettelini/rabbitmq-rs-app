\documentclass[../documentation.tex]{subfiles}

\begin{document}

\subsection{Frontend}

\subsection{Webserver}

\subsubsection{Routing}

The webserver

\subsubsection{Templating}

Templating is used to programmatically serve HTML content based on some logic.
To do so a template engine is needed. The template engine renders the HTML content
when needed.

I used a template engine library for Rust called
\href{https://github.com/Keats/tera}{tera} \cite[tera].
Logic blocks can be integrated in the HTML file like so
\begin{lstlisting}[language=html]
<ul>
{% for user in users %}
    <li><a href="{{ user.url}}">{{ user.url }}</li>
{% endfor %}
</ul>
\end{lstlisting}

HTML files containing templating needs to be stored in RAM.
When the webservers starts it loads from the \texttt{www} folder
every file containing templating code.

\subsubsection{Routing}

The webserver needs to respond to different routes.
I used a composable Rust framework called rust
\href{https://github.com/seanmonstar/warp}{warp} \cite{warp}. 


\subsection{Database}

The databased is an instance of \texttt{MariaDB}.

\begin{lstlisting}[style=sql]
    CREATE TABLE user (
        id INT PRIMARY KEY AUTO_INCREMENT,
        mail VARCHAR(50) NOT NULL,
        username VARCHAR(25) NOT NULL,
        password BINARY(32) NOT NULL,
        created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
    );
\end{lstlisting}

\begin{lstlisting}[style=sql]
    CREATE TABLE image (
        id INT PRIMARY KEY AUTO_INCREMENT,
        user_id INT NOT NULL,
        uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        data BLOB NOT NULL,
        FOREIGN KEY (user_id)
            REFERENCES user(id)
                ON UPDATE CASCADE
                ON DELETE CASCADE
    );
\end{lstlisting}

\subsubsection{Diesel}

\texttt{diesel} is an ORM library for the Rust programming language.
It supports MySQL, Postgres and SQLite.

\subsection{Load Balancer}

\subsection{Backend}

\subsection{Messaging}

\subsubsection{RabbitMQ}

\subsubsection{Messages}

\newcommand{\tline}{
    \\ \hline
}

\newcommand{\packetstruct}[1]{
    \bgroup{}
    \def\arraystretch{1.25}
    %\begin{center}
        \begin{tabular}{|l|l|l|}
            \hline
            \textbf{Field} & \textbf{Type} & \textbf{Description}
            \tline
            
            \if\relax\detokenize{#1}\relax
            \else
                #1
                \tline
            \fi
        \end{tabular}
    %\end{center}
    \egroup{}
}

\newcommand{\packetenum}[1]{
    \bgroup{}
    \def\arraystretch{1.25}
    %\begin{center}
        \begin{tabular}{|l|l|l|}
            \hline
            \textbf{Field} & \textbf{Content} & \textbf{Description}
            \tline
            
            \if\relax\detokenize{#1}\relax
            \else
                #1
                \tline
            \fi
        \end{tabular}
    %\end{center}
    \egroup{}
}

% make links between stuff
\newcommand{\packettitle}[1]{
    \paragraph{#1} \hphantom{ } \\
}

\packettitle{RabbitMessage (enum)}
\packetenum{
    LoginRequest & LoginRequestData & Login request packet
    \tline
    LoginResponse & LoginResponseData & Login response packet
    \tline
    RegisterRequest & RegisterRequestData & Register request packet
    \tline
    RegisterResponse & RegisterResponseData & Register response packet
    \tline
    GetImage & GetImageData & Get image data packet
    \tline
    ShrinkAndUpload & ShrinkAndUploadData & Shrink and upload image packet
    \tline
    GetTotalImages & GetTotalImagesData & Get total images packet
    \tline
    GetTotalImagesResponse & GetTotalImagesResponseData & Get total images response
    \tline
    ErrorResponse & ErrorResponseData & Error packet
}

\packettitle{LoginRequestData (struct)}
\packetstruct{
    mail & String & The mail
    \tline
    username & String & The username
    \tline
    password & Vec<u8> & The password
}

\packettitle{LoginResponseData}
\packetenum{
    Ok & LoginResponseDataOk & Positive login response
    \tline
    Err & LoginResponseDataErr & Negative login response
}

\packettitle{LoginResponseDataOk}
\packetstruct{
    token & Vec<u8> & The authentication token
}

\packettitle{LoginResponseDataErr}
\packetenum{
    NotFound & () & User was not not
    \tline
    WrongPassword & () & Password was incorrect
}

\packettitle{RegisterRequestData}
\packetstruct{
    mail & String & The mail
    \tline
    username & String 6 The username
    \tline
    password & Vec<u8> & The password
}

\packettitle{RegisterResponseData}
\packetenum{
    Ok & (RegisterResponseDataOk) & Positive register response
    \tline
    Err & (RegisterResponseDataErr) & Negative register response
}

\packettitle{RegisterResponseDataOk}
\packetstruct{
    token & Vec<u8> & The authentication token
}

\packettitle{RegisterResponseDataErr}
\packetenum{
    AlreadyExists & () & User already exists
}

\packettitle{GetImageData}
\packetstruct{
    username & String & The username
    \tline
    token & Vec<u8> & The auth token
    \tline
    index & u16 & The image index
}

\packettitle{ShrinkAndUploadData}
\packetstruct{
    username & String & The username
    \tline
    token & Vec<u8> & The auth token
    \tline
    image & Image 6 The image
}

\packettitle{GetTotalImagesData}
\packetstruct{
    username & String & The username
    \tline
    token & Vec<u8> & The auth token
}

\packettitle{GetTotalImagesResponseData}
\packetstruct{
    amount & u32 & The amount of images
}

\packettitle{ErrorResponseData}
\packetenum{
    AuthenticationRequired & () & Authentication failed
    \tline
    UnknownUsername & () & Username is unknown
}

% TODO alias types e.g. Image

\end{document}